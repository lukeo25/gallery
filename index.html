<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Virtual Gallery</title>

  <!-- Pannellum CSS & JS -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/pannellum@2.5.6/build/pannellum.css">
  <script src="https://cdn.jsdelivr.net/npm/pannellum@2.5.6/build/pannellum.js"></script>

  <style>
    html, body { height: 100%; margin: 0; background: #0b0d10; color: #e7ecf2; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; }
    #app { display: grid; grid-template-rows: auto 1fr; height: 100%; }
    header { padding: 10px 14px; background: #12151a; border-bottom: 1px solid #1e2230; display: flex; gap: 12px; align-items: center; }
    header h1 { font-size: 16px; font-weight: 600; margin: 0; letter-spacing: .3px; }
    header .hint { opacity: .75; font-size: 13px; }

    #panoc { height: calc(100vh - 48px); position: relative; }
    .pnlm-container { position: relative; overflow: hidden; }
    .pnlm-render-container, .pnlm-render-canvas { width: 100%; height: 100%; display: block; }

    /* Wrapper we rotate for fake perspective */
    .art-wrap {
      transform-origin: center center;
      will-change: transform;
    }

    /* The tile (billboard). Size is set dynamically per image. */
    .art-slot {
      /* width/height are set in JS after we know image ratio */
      border: 4px solid rgba(255,255,255,.9);
      box-shadow: 0 6px 20px rgba(0,0,0,.45), inset 0 0 0 1px rgba(0,0,0,.25);
      border-radius: 6px;
      background-size: cover;
      background-position: center;
      background-repeat: no-repeat;
      cursor: pointer;

      /* Fade in once placed & sized. No transform transition (prevents “slide-in”). */
      opacity: 0;
      transition: opacity .22s ease, box-shadow .15s ease;
    }
    .art-slot.ready { opacity: 1; }
    .art-slot:hover { box-shadow: 0 10px 24px rgba(0,0,0,.6), inset 0 0 0 1px rgba(0,0,0,.25); }

    .art-slot::after {
      content: attr(data-artno);
      position: absolute; right: -10px; top: -10px; width: 28px; height: 28px; border-radius: 999px;
      display: grid; place-items: center; background: #111923; color: #e7ecf2; font-size: 12px; border: 2px solid #3a4a63;
      box-shadow: 0 4px 10px rgba(0,0,0,.45);
    }

    /* Info card */
    .card-overlay {
      position: fixed; inset: auto 16px 16px auto; width: min(520px, calc(100% - 32px)); max-height: 80vh;
      border-radius: 14px; background: #0f141b; border: 1px solid #1e2633; box-shadow: 0 20px 60px rgba(0,0,0,.6);
      color: #e7ecf2; overflow: hidden; display: none; z-index: 20;
    }
    .card-header { display: grid; grid-template-columns: 1fr auto; gap: 8px; align-items: center; padding: 14px 14px 10px; border-bottom: 1px solid #1b2230; }
    .card-title { margin: 0; font-size: 18px; font-weight: 700; letter-spacing: .2px; }
    .card-meta { font-size: 13px; opacity: .8; }
    .card-close { appearance: none; background: transparent; color: #aeb9cc; border: 0; font-size: 22px; line-height: 1; cursor: pointer; padding: 6px 10px; border-radius: 8px; }
    .card-close:hover { color: #fff; background: #182132; }
    .card-body { display: grid; grid-template-columns: 180px 1fr; gap: 14px; padding: 14px; align-items: start; }
    .card-body img { width: 180px; height: 135px; object-fit: cover; border-radius: 8px; border: 1px solid #263145; box-shadow: 0 6px 24px rgba(0,0,0,.45); }
    .card-desc { font-size: 14px; line-height: 1.45; color: #d6deea; white-space: pre-wrap; }
    .card-tags { margin-top: 8px; display: flex; flex-wrap: wrap; gap: 8px; }
    .tag { font-size: 12px; padding: 4px 8px; border-radius: 999px; background: #132033; color: #cfe0ff; border: 1px solid #21324a; }

    .toast { position: fixed; left: 50%; transform: translateX(-50%); bottom: 20px; background: #0f141b; color: #d4ddea; padding: 10px 14px; border-radius: 10px; font-size: 13px; border: 1px solid #223148; display: none; z-index: 30; }
  </style>
</head>
<body>
  <div id="app">
    <header>
      <h1>Virtual Gallery</h1>
      <div class="hint">Click a frame to open its card. Drag to look around. Scroll to zoom.</div>
    </header>
    <div id="panoc"></div>
  </div>

  <aside id="card" class="card-overlay" aria-live="polite" aria-modal="true">
    <div class="card-header">
      <div>
        <h2 id="cardTitle" class="card-title"></h2>
        <div id="cardMeta" class="card-meta"></div>
      </div>
      <button id="cardClose" class="card-close" title="Close">×</button>
    </div>
    <div class="card-body">
      <img id="cardImg" alt="Artwork preview" />
      <div>
        <div id="cardDesc" class="card-desc"></div>
        <div id="cardTags" class="card-tags"></div>
      </div>
    </div>
  </aside>

  <div id="toast" class="toast"></div>

  <script>
    /* ===== Your repo (public) ===== */
    const GH_USER = "lukeo25";
    const GH_REPO = "gallery";

    /* Panorama: raw URL avoids relative path issues */
    const PANORAMA_URL = "https://raw.githubusercontent.com/lukeo25/gallery/refs/heads/main/gallery/gallery001.png";

    /* List images in artworks/ via GitHub Contents API */
    const GITHUB_CONTENTS_API = `https://api.github.com/repos/${GH_USER}/${GH_REPO}/contents/artworks`;

    /* Layout */
    const LAYOUT = { rows: 1, pitchTopDeg: 3, pitchRowGapDeg: -12, yawOffsetDeg: 0 };

    /* Fake perspective parameters */
    const TILT = {
      yawFactor: 0.85,
      pitchFactor: 0.60,
      maxYaw: 35,
      maxPitch: 25,
      perspective: 900
    };

    /* Size box for artworks (CSS pixels before Pannellum scales them) */
    const SIZE_BOX = { maxW: 240, maxH: 240, minW: 100, minH: 100 };

    /* Helpers */
    function el(q){ return document.querySelector(q); }
    function toast(msg,ms=2400){ const t=el('#toast'); t.textContent=msg; t.style.display='block'; clearTimeout(toast._h); toast._h=setTimeout(()=>t.style.display='none',ms); }
    function escapeHtml(s){ return String(s).replace(/[&<>"']/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }
    function clamp(v,a,b){ return Math.max(a, Math.min(b, v)); }
    function normDeg(d){ d = ((d + 180) % 360 + 360) % 360 - 180; return d; }

    function numFromFilename(name){
      const m = /^(\d+)\.(png|jpg|jpeg|webp)$/i.exec(name);
      return m ? parseInt(m[1], 10) : null;
    }

    async function fetchArtworkList(){
      const res = await fetch(GITHUB_CONTENTS_API, { cache: 'no-store' });
      if(!res.ok) throw new Error("GitHub API " + res.status);
      const files = await res.json();
      return files
        .filter(f => f.type === "file" && /\.(png|jpg|jpeg|webp)$/i.test(f.name))
        .map(f => ({ number: numFromFilename(f.name), name: f.name, url: f.download_url }))
        .filter(x => Number.isFinite(x.number))
        .sort((a,b) => a.number - b.number)
        .map(x => ({
          number: String(x.number),
          title: "", artist: "", year: "", medium: "", dimensions: "", price: "", description: "",
          imageUrl: x.url
        }));
    }

    function positionForIndex(i,total){
      const rows = Math.max(1, LAYOUT.rows|0);
      const perRow = Math.ceil(total/rows);
      const row = Math.floor(i/perRow);
      const idxInRow = i - row*perRow;
      const countThisRow = Math.min(perRow, total - row*perRow);
      const yawStep = 360 / Math.max(1, countThisRow);
      const yaw = -180 + (idxInRow + 0.5) * yawStep + LAYOUT.yawOffsetDeg;
      const pitch = (LAYOUT.pitchTopDeg + row * LAYOUT.pitchRowGapDeg);
      return { yaw, pitch };
    }

    /* Keep refs to wrappers for tilt updates */
    const HOTSPOTS = []; // {wrap, yaw, pitch}

    let viewer = null, rafId = null;

    function initPano(){
      if(viewer){ try{ viewer.destroy(); }catch{} }
      if(rafId){ cancelAnimationFrame(rafId); rafId = null; }
      HOTSPOTS.length = 0;

      viewer = pannellum.viewer('panoc', {
        type: 'equirectangular',
        panorama: PANORAMA_URL,
        autoLoad: true,
        showControls: true,
        yaw: 0, pitch: 0, hfov: 85, minHfov: 40, maxHfov: 110,
        backgroundColor: [11,13,16]
      });

      viewer.on('error', e => { console.error('Pannellum error:', e); toast('Error loading panorama'); });

      viewer.on('load', async () => {
        try {
          const items = await fetchArtworkList();
          addArtHotspots(items);
          // Fade in after Pannellum places them and we size them
          requestAnimationFrame(() => {
            document.querySelectorAll('.art-slot').forEach(n => n.classList.add('ready'));
          });
          tiltLoop();
          toast(`${items.length} artworks loaded`);
        } catch (err) {
          console.error(err);
          toast("Couldn't list /artworks via GitHub API");
        }
      });
    }

    function slotRenderer(div, args){
      // Build wrapper we rotate for perspective
      const wrap = document.createElement('div');
      wrap.className = 'art-wrap';
      wrap.style.transform = `perspective(${TILT.perspective}px)`;

      const tile = document.createElement('div');
      tile.className = 'art-slot';
      tile.style.backgroundImage = `url("${args.imageUrl}")`;
      tile.setAttribute('data-artno', args.number);
      tile.setAttribute('role', 'button');
      tile.setAttribute('tabindex', '0');

      wrap.appendChild(tile);
      div.appendChild(wrap);

      // Click / keyboard
      tile.addEventListener('click', ()=>openCard(args));
      tile.addEventListener('keydown', e=>{ if(e.key==='Enter'||e.key===' '){ e.preventDefault(); openCard(args);} });

      // Measure the image and set the exact aspect-ratio size
      const img = new Image();
      img.onload = () => {
        const iw = img.naturalWidth || 1;
        const ih = img.naturalHeight || 1;
        const aspect = iw / ih;

        // Fit inside SIZE_BOX while keeping aspect; also respect minimums
        let w = SIZE_BOX.maxW, h = w / aspect;
        if (h > SIZE_BOX.maxH) { h = SIZE_BOX.maxH; w = h * aspect; }
        if (w < SIZE_BOX.minW) { w = SIZE_BOX.minW; h = w / aspect; }
        if (h < SIZE_BOX.minH) { h = SIZE_BOX.minH; w = h * aspect; }

        tile.style.width = `${Math.round(w)}px`;
        tile.style.height = `${Math.round(h)}px`;
      };
      img.onerror = () => {
        // Fallback size if image meta fails
        tile.style.width = `${SIZE_BOX.minW}px`;
        tile.style.height = `${SIZE_BOX.minH}px`;
      };
      img.src = args.imageUrl;

      // Register for tilt updates
      HOTSPOTS.push({ wrap, yaw: args._yaw, pitch: args._pitch });
    }

    function addArtHotspots(items){
      const total = items.length;
      items.forEach((art, i) => {
        const pos = positionForIndex(i,total);
        viewer.addHotSpot({
          pitch: pos.pitch,
          yaw: pos.yaw,
          scale: true,                 // scale with zoom to feel anchored
          cssClass: 'art-slot',        // ok on container; our tile is inside wrap
          createTooltipFunc: slotRenderer,
          createTooltipArgs: { ...art, _yaw: pos.yaw, _pitch: pos.pitch }
        });
      });
    }

    /* Tilt wrappers so they appear planar-ish relative to camera */
    function updateTilt(){
      if(!viewer) return;
      const cy = viewer.getYaw();
      const cp = viewer.getPitch();
      for(const h of HOTSPOTS){
        const dy = normDeg(h.yaw - cy);
        const dp = normDeg(h.pitch - cp);
        const ry = clamp(dy * TILT.yawFactor, -TILT.maxYaw, TILT.maxYaw);
        const rx = clamp(-dp * TILT.pitchFactor, -TILT.maxPitch, TILT.maxPitch);
        h.wrap.style.transform = `perspective(${TILT.perspective}px) rotateY(${ry}deg) rotateX(${rx}deg)`;
      }
    }
    function tiltLoop(){ updateTilt(); rafId = requestAnimationFrame(tiltLoop); }

    function openCard(a){
      el('#cardTitle').textContent = a.title || `Artwork ${a.number}`;
      const meta = [];
      if (a.artist) meta.push(a.artist);
      if (a.year) meta.push(a.year);
      if (a.medium) meta.push(a.medium);
      if (a.dimensions) meta.push(a.dimensions);
      if (a.price) meta.push(a.price);
      el('#cardMeta').textContent = meta.join(' • ');
      el('#cardImg').src = a.imageUrl;
      el('#cardDesc').textContent = a.description || '';
      const tags = [];
      if (a.number) tags.push(`#${a.number}`);
      if (a.title) tags.push(a.title);
      el('#cardTags').innerHTML = tags.map(t=>`<span class="tag">${escapeHtml(t)}</span>`).join('');
      el('#card').style.display = 'block';
      document.addEventListener('keydown', escListener);
    }
    function closeCard(){ el('#card').style.display = 'none'; document.removeEventListener('keydown', escListener); }
    function escListener(e){ if(e.key==='Escape') closeCard(); }
    el('#cardClose').addEventListener('click', closeCard);

    (function main(){ initPano(); })();
  </script>
</body>
</html>
