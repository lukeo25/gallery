<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Virtual Gallery</title>

  <!-- Pannellum CSS & JS -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/pannellum@2.5.6/build/pannellum.css">
  <script src="https://cdn.jsdelivr.net/npm/pannellum@2.5.6/build/pannellum.js"></script>

  <style>
    html, body { height: 100%; margin: 0; background: #0b0d10; color: #e7ecf2; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; }
    #app { display: grid; grid-template-rows: auto 1fr; height: 100%; }
    header { padding: 10px 14px; background: #12151a; border-bottom: 1px solid #1e2230; display: flex; gap: 12px; align-items: center; }
    header h1 { font-size: 16px; font-weight: 600; margin: 0; letter-spacing: .3px; }
    header .hint { opacity: .75; font-size: 13px; }
    #panoc { height: calc(100vh - 48px); position: relative; }

    /* Safety sizing in case CDN CSS is slow */
    .pnlm-container { position: relative; overflow: hidden; }
    .pnlm-render-container, .pnlm-render-canvas { width: 100%; height: 100%; display: block; }

    /* Hotspot tiles */
    .art-slot {
      width: 180px; height: 120px;
      border: 4px solid rgba(255,255,255,.85);
      box-shadow: 0 6px 20px rgba(0,0,0,.45), inset 0 0 0 1px rgba(0,0,0,.25);
      border-radius: 6px;
      background-size: cover; background-position: center; background-repeat: no-repeat;
      cursor: pointer; transition: transform .15s ease, box-shadow .15s ease;
    }
    .art-slot:hover { transform: translateY(-2px) scale(1.02); box-shadow: 0 10px 24px rgba(0,0,0,.55), inset 0 0 0 1px rgba(0,0,0,.25); }
    .art-slot::after {
      content: attr(data-artno);
      position: absolute; right: -10px; top: -10px; width: 28px; height: 28px; border-radius: 999px;
      display: grid; place-items: center; background: #111923; color: #e7ecf2; font-size: 12px; border: 2px solid #3a4a63;
      box-shadow: 0 4px 10px rgba(0,0,0,.45);
    }

    /* Info card */
    .card-overlay {
      position: fixed; inset: auto 16px 16px auto; width: min(520px, calc(100% - 32px)); max-height: 80vh;
      border-radius: 14px; background: #0f141b; border: 1px solid #1e2633; box-shadow: 0 20px 60px rgba(0,0,0,.6);
      color: #e7ecf2; overflow: hidden; display: none; z-index: 20;
    }
    .card-header { display: grid; grid-template-columns: 1fr auto; gap: 8px; align-items: center; padding: 14px 14px 10px; border-bottom: 1px solid #1b2230; }
    .card-title { margin: 0; font-size: 18px; font-weight: 700; letter-spacing: .2px; }
    .card-meta { font-size: 13px; opacity: .8; }
    .card-close { appearance: none; background: transparent; color: #aeb9cc; border: 0; font-size: 22px; line-height: 1; cursor: pointer; padding: 6px 10px; border-radius: 8px; }
    .card-close:hover { color: #fff; background: #182132; }
    .card-body { display: grid; grid-template-columns: 180px 1fr; gap: 14px; padding: 14px; align-items: start; }
    .card-body img { width: 180px; height: 135px; object-fit: cover; border-radius: 8px; border: 1px solid #263145; box-shadow: 0 6px 24px rgba(0,0,0,.45); }
    .card-desc { font-size: 14px; line-height: 1.45; color: #d6deea; white-space: pre-wrap; }
    .card-tags { margin-top: 8px; display: flex; flex-wrap: wrap; gap: 8px; }
    .tag { font-size: 12px; padding: 4px 8px; border-radius: 999px; background: #132033; color: #cfe0ff; border: 1px solid #21324a; }

    .toast { position: fixed; left: 50%; transform: translateX(-50%); bottom: 20px; background: #0f141b; color: #d4ddea; padding: 10px 14px; border-radius: 10px; font-size: 13px; border: 1px solid #223148; display: none; z-index: 30; }
  </style>
</head>
<body>
  <div id="app">
    <header>
      <h1>Virtual Gallery</h1>
      <div class="hint">Click a frame to open its card. Drag to look around. Scroll to zoom.</div>
    </header>
    <div id="panoc"></div>
  </div>

  <aside id="card" class="card-overlay" aria-live="polite" aria-modal="true">
    <div class="card-header">
      <div>
        <h2 id="cardTitle" class="card-title"></h2>
        <div id="cardMeta" class="card-meta"></div>
      </div>
      <button id="cardClose" class="card-close" title="Close">×</button>
    </div>
    <div class="card-body">
      <img id="cardImg" alt="Artwork preview" />
      <div>
        <div id="cardDesc" class="card-desc"></div>
        <div id="cardTags" class="card-tags"></div>
      </div>
    </div>
  </aside>

  <div id="toast" class="toast"></div>

  <script>
    /* ===== Paths & options (absolute URLs remove ambiguity) ===== */
    const PANORAMA_URL   = "https://lukeo25.github.io/ArtGallery/gallery/gallery001.png";
    const ART_IMAGE_BASE = "https://lukeo25.github.io/ArtGallery/artwork/";
    const ART_IMAGE_EXT  = ".png";
    const ZERO_PAD       = 3;

    /* Scan for artwork/001.png..up to this many */
    const ART_MAX_INDEX = 500;
    const CONCURRENCY   = 16;

    /* Optional Google Sheet CSV (publish to web -> CSV). Leave empty to skip. */
    const SHEET_CSV_URL = "";

    /* Layout across the panorama */
    const LAYOUT = { rows: 1, pitchTopDeg: 3, pitchRowGapDeg: -12, yawOffsetDeg: 0 };

    /* ===== Helpers ===== */
    function el(q){ return document.querySelector(q); }
    function zeroPad(n,w){ const s = String(n); return s.length >= w ? s : "0".repeat(w - s.length) + s; }
    function toast(msg,ms=2600){ const t=el('#toast'); t.textContent=msg; t.style.display='block'; clearTimeout(toast._h); toast._h=setTimeout(()=>t.style.display='none',ms); }
    function escapeHtml(s){ return String(s).replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }

    function parseCSV(text){
      const rows=[]; let i=0, field='', row=[], q=false;
      while(i<text.length){ const c=text[i++]; if(q){ if(c==='\"'){ if(text[i]==='\"'){ field+='\"'; i++; } else { q=false; } } else { field+=c; } }
      else { if(c==='\"'){ q=true; } else if(c===','){ row.push(field); field=''; } else if(c==='\n'||c==='\r'){ if(field!==''||row.length){ row.push(field); rows.push(row); row=[]; field=''; } } else { field+=c; } } }
      if(field!==''||row.length){ row.push(field); rows.push(row); }
      const head=rows.shift().map(h=>h.trim());
      return rows.filter(r=>r.length && r.some(v=>String(v).trim()!==''))
                 .map(r=>Object.fromEntries(head.map((h,idx)=>[h,(r[idx]||'').trim()])));
    }

    async function fetchCSVMap(){
      if(!SHEET_CSV_URL) return new Map();
      try{
        const res = await fetch(SHEET_CSV_URL, { cache:'no-store' });
        if(!res.ok) throw new Error('CSV ' + res.status);
        const rows = parseCSV(await res.text());
        const map = new Map();
        for(const r of rows){
          const num = parseInt(r.number,10);
          if(Number.isFinite(num)) map.set(num, r);
        }
        return map;
      }catch(e){ console.warn('CSV load failed:', e); return new Map(); }
    }

    function resolveImageURL(fileName){
      if(/^https?:\/\//i.test(fileName)) return fileName;
      const base = ART_IMAGE_BASE.endsWith('/') ? ART_IMAGE_BASE : ART_IMAGE_BASE + '/';
      return base + fileName.replace(/^\/*/,'');
    }

    async function exists(url){
      try{
        const res = await fetch(url, { method:'HEAD', cache:'no-store' });
        return res.ok;
      }catch{ return false; }
    }

    async function discoverArtworkNumbers(){
      const nums = Array.from({length: ART_MAX_INDEX}, (_,i)=>i+1);
      const found = [];
      let idx = 0;

      async function worker(){
        while(idx < nums.length){
          const n = nums[idx++]; // take next
          const url = resolveImageURL(zeroPad(n, ZERO_PAD) + ART_IMAGE_EXT);
          if(await exists(url)) found.push(n);
        }
      }
      await Promise.all(Array.from({length: CONCURRENCY}, worker));
      found.sort((a,b)=>a-b);
      return found;
    }

    async function loadArtData(){
      const csvMap = await fetchCSVMap();
      const numbers = await discoverArtworkNumbers();
      const items = numbers.map(n => {
        const meta = csvMap.get(n) || {};
        const imageUrl = meta.image && meta.image.trim()
          ? resolveImageURL(meta.image.trim())
          : resolveImageURL(zeroPad(n, ZERO_PAD) + ART_IMAGE_EXT);
        return {
          number: String(n),
          title:  meta.title || '',
          artist: meta.artist || '',
          year:   meta.year || '',
          medium: meta.medium || '',
          dimensions: meta.dimensions || '',
          price:  meta.price || '',
          description: meta.description || '',
          imageUrl
        };
      });
      return items;
    }

    function positionForIndex(i,total){
      const rows = Math.max(1, LAYOUT.rows|0);
      const perRow = Math.ceil(total/rows);
      const row = Math.floor(i/perRow);
      const idxInRow = i - row*perRow;
      const countThisRow = Math.min(perRow, total - row*perRow);
      const yawStep = 360 / countThisRow;
      const yaw = -180 + (idxInRow + 0.5) * yawStep + LAYOUT.yawOffsetDeg;
      const pitch = (LAYOUT.pitchTopDeg + row * LAYOUT.pitchRowGapDeg);
      return { yaw, pitch };
    }

    let viewer = null;
    let loadTimer = null;

    function initPano(){
      if(viewer){ try{ viewer.destroy(); }catch{} }

      viewer = pannellum.viewer('panoc', {
        type: 'equirectangular',
        panorama: PANORAMA_URL,
        autoLoad: true,
        showControls: true,
        yaw: 0, pitch: 0, hfov: 85, minHfov: 40, maxHfov: 110,
        backgroundColor: [11,13,16]
      });

      viewer.on('error', e => {
        console.error('Pannellum error:', e);
        toast('Error loading panorama. See console.');
      });

      clearTimeout(loadTimer);
      loadTimer = setTimeout(() => {
        toast('Still loading… check that gallery001.png is reachable.');
        console.warn('Timeout: pano likely not reachable at', PANORAMA_URL);
      }, 9000);

      viewer.on('load', async () => {
        clearTimeout(loadTimer);
        const items = await loadArtData();
        addArtHotspots(items);
        toast(`${items.length} artworks loaded`);
      });
    }

    function slotRenderer(div, args){
      div.classList.add('art-slot');
      div.setAttribute('data-artno', args.number);
      div.style.backgroundImage = `url("${args.imageUrl}")`;
      div.addEventListener('click', ()=>openCard(args));
      div.setAttribute('role','button');
      div.setAttribute('tabindex','0');
      div.addEventListener('keydown', e => {
        if(e.key==='Enter' || e.key===' '){ e.preventDefault(); openCard(args); }
      });
    }

    function addArtHotspots(items){
      const total = items.length;
      items.forEach((art, i) => {
        const pos = positionForIndex(i, total);
        viewer.addHotSpot({
          pitch: pos.pitch,
          yaw: pos.yaw,
          cssClass: 'art-slot',
          createTooltipFunc: slotRenderer,
          createTooltipArgs: art
        });
      });
    }

    function openCard(a){
      el('#cardTitle').textContent = a.title || `Artwork ${a.number}`;
      const meta = [];
      if (a.artist) meta.push(a.artist);
      if (a.year) meta.push(a.year);
      if (a.medium) meta.push(a.medium);
      if (a.dimensions) meta.push(a.dimensions);
      if (a.price) meta.push(a.price);
      el('#cardMeta').textContent = meta.join(' • ');
      el('#cardImg').src = a.imageUrl;
      el('#cardDesc').textContent = a.description || '';
      const tags = [];
      if (a.number) tags.push(`#${a.number}`);
      if (a.title) tags.push(a.title);
      el('#cardTags').innerHTML = tags.map(t => `<span class="tag">${escapeHtml(t)}</span>`).join('');
      el('#card').style.display = 'block';
      document.addEventListener('keydown', escListener);
    }

    function closeCard(){ el('#card').style.display = 'none'; document.removeEventListener('keydown', escListener); }
    function escListener(e){ if(e.key === 'Escape') closeCard(); }
    el('#cardClose').addEventListener('click', closeCard);

    (function main(){ initPano(); })();
  </script>
</body>
</html>
